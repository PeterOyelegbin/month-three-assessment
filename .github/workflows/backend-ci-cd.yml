name: Backend CI/CD
on:
  push:
    branches: [main, stagging]
    paths:
      - 'Server/**'
      - '.github/workflows/backend-cicd.yml'
  pull_request:
    branches: [dev]
    paths: ['Server/**']
  workflow_dispatch:

env:
  DOCKER_REPOSITORY: starttech-backend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    strategy:
      matrix:
        go-version: [1.25.x]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}

    - name: Install dependencies
      run: go mod download

    - name: Run linter
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest

    - name: Run unit tests
      run: go test -v -race ./... -coverprofile=coverage.out

    - name: Generate coverage report
      run: go tool cover -html=coverage.out -o coverage.html

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          backend/coverage.out
          backend/coverage.html

    - name: Run security scan
      run: |
        go install github.com/securego/gosec/v2/cmd/gosec@latest
        gosec ./...

  # build:
  #   needs: test
  #   if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: ./backend

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Configure AWS Credentials
  #     uses: aws-actions/configure-aws-credentials@v2
  #     with:
  #       aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #       aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #       aws-region: ${{ env.AWS_REGION }}

  #   - name: Login to Amazon ECR
  #     id: login-ecr
  #     uses: aws-actions/amazon-ecr-login@v1

  #   - name: Build Docker image
  #     run: |
  #       docker build \
  #         --build-arg BUILDKIT_INLINE_CACHE=1 \
  #         -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} \
  #         -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest \
  #         .

  #   - name: Scan Docker image
  #     uses: aquasecurity/trivy-action@master
  #     with:
  #       image-ref: '${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}'
  #       format: 'sarif'
  #       output: 'trivy-results.sarif'

  #   - name: Upload Trivy scan results
  #     uses: github/codeql-action/upload-sarif@v2
  #     if: always()
  #     with:
  #       sarif_file: 'trivy-results.sarif'

  #   - name: Push Docker image
  #     if: success()
  #     run: |
  #       docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
  #       docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

  # deploy:
  #   needs: build
  #   if: github.ref == 'refs/heads/main'
  #   runs-on: ubuntu-latest

  #   steps:
  #   - name: Configure AWS Credentials
  #     uses: aws-actions/configure-aws-credentials@v2
  #     with:
  #       aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #       aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #       aws-region: ${{ env.AWS_REGION }}

  #   - name: Update launch template
  #     run: |
  #       LATEST_LT_VERSION=$(aws ec2 describe-launch-template-versions \
  #         --launch-template-id ${{ secrets.LAUNCH_TEMPLATE_ID }} \
  #         --query 'LaunchTemplateVersions[0].VersionNumber' \
  #         --output text)

  #       aws ec2 create-launch-template-version \
  #         --launch-template-id ${{ secrets.LAUNCH_TEMPLATE_ID }} \
  #         --source-version $LATEST_LT_VERSION \
  #         --version-description "Deploy ${{ env.IMAGE_TAG }}" \
  #         --launch-template-data "{\"UserData\":\"$(base64 -w0 backend/userdata.sh)\"}"

  #   - name: Start instance refresh
  #     run: |
  #       aws autoscaling start-instance-refresh \
  #         --auto-scaling-group-name ${{ secrets.ASG_NAME }} \
  #         --strategy Rolling \
  #         --preferences '{"InstanceWarmup": 300, "MinHealthyPercentage": 90}'

  #   - name: Run smoke tests
  #     run: |
  #       ./scripts/health-check.sh ${{ secrets.ALB_DNS_NAME }}

  #   - name: Notify deployment
  #     if: success()
  #     uses: rtCamp/action-slack-notify@v2
  #     env:
  #       SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  #       SLACK_CHANNEL: deployments
  #       SLACK_COLOR: good
  #       SLACK_TITLE: "Backend Deployed Successfully"
  #       SLACK_MESSAGE: "Backend version ${{ env.IMAGE_TAG }} deployed to production"
